{% extends 'base.html' %}

{% block content %}
<h2>Salon : {{ room.name }}</h2>

<div id="chat-box" class="border p-3 mb-3" style="height: 300px; overflow-y: scroll; background: white;">
    {% for message in messages %}
        <div class="message mb-2">
            <strong>{{ message.user.username }}</strong>: {{ message.content }} 
            <small class="text-muted">({{ message.timestamp|date:"H:i" }})</small>

            {% if user.is_authenticated %}
                <form action="{% url 'flag_message' message.id %}" method="post" class="d-inline ms-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-warning py-0" style="font-size: 0.7rem;" title="Signaler ce message">
                        üö© Signaler
                    </button>
                </form>
            {% endif %}

            {% if message.is_flagged %}
                <span class="badge bg-danger">Signal√©</span>
            {% endif %}
        </div>
    {% endfor %}
</div>

<form id="message-form">
    {% csrf_token %}
    <input type="hidden" id="room_id" value="{{ room.id }}">
    <div class="input-group">
        <input type="text" id="msg-content" class="form-control" placeholder="√âcrivez votre message..." required>
        <button type="submit" class="btn btn-primary">Envoyer</button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('#message-form').on('submit', function(e) {
            e.preventDefault();

            let content = $('#msg-content').val();
            let roomId = $('#room_id').val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val();

            $.ajax({
                url: "{% url 'send_message' %}",
                type: "POST",
                data: {
                    'content': content,
                    'room_id': roomId,
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function(response) {
                    if (response.status === 'success') {

                        let flagForm = `
                            <form action="/flag/${response.message_id}/" method="post" class="d-inline ms-2">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <button type="submit" class="btn btn-sm btn-outline-warning py-0" style="font-size: 0.7rem;">
                                    üö© Signaler
                                </button>
                            </form>`;
                        // On ajoute le nouveau message
                        // Note : Le nouveau message n'aura pas de bouton "Signaler" 
                        // tant que la page n'est pas rafra√Æchie (c'est normal pour l'instant)
                        $('#chat-box').append(
                            '<div class="message mb-2"><strong>' + response.user + '</strong>: ' + response.content + ' <small class="text-muted">(' + response.timestamp + ')</small>' + flagForm +'</div>'
                        );
                        $('#msg-content').val('');
                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    }
                },
                error: function() {
                    alert("Erreur lors de l'envoi du message.");
                }
            });
        });
    });
    function fetchMessages() {
        let roomId = $('#room_id').val();
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val(); // On r√©cup√®re le token pr√©sent sur la page

        $.ajax({
            url: "/get_messages/" + roomId + "/",
            type: "GET",
            success: function(response) {
                // On vide la bo√Æte de chat et on la remplit avec les messages frais
                $('#chat-box').empty();
                response.messages.forEach(function(msg) {
                    let flaggedBadge = msg.is_flagged ? ' <span class="badge bg-danger">Signal√©</span>' : '';

                    let flagButton = `
                    <form action="/flag/${msg.id}/" method="post" class="d-inline ms-2">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                        <button type="submit" class="btn btn-sm btn-outline-warning py-0" style="font-size: 0.7rem;">
                            üö© Signaler
                        </button>
                    </form>`;

                    $('#chat-box').append(
                        '<div class="message mb-2"><strong>' + msg.user + '</strong>: ' + msg.content + 
                        ' <small class="text-muted">(' + msg.timestamp + ')</small>' + flagButton + flaggedBadge + '</div>'
                    );
                });
            }
        });
    }

    // On appelle la fonction toutes les 3 secondes
    setInterval(fetchMessages, 3000);
</script>
{% endblock %}