{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="fw-bold mb-0">Salon : <span class="text-primary">{{ room.name }}</span></h2>
        </div>
        <a href="{% url 'index' %}" class="btn btn-dark btn-sm rounded-pill px-3 border-secondary text-muted">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
    </div>

    <div id="chat-box" class="rounded shadow-sm p-4 mb-3" 
         style="height: 550px; overflow-y: scroll; background-color: #0c0d0e; border: 1px solid #2d3238; display: flex; flex-direction: column;">
    </div>

    <div class="sticky-bottom p-3 border-top rounded-top" style="background-color: #131517; border-color: #2d3238 !important;">
        <div id="emoji-picker-container" style="position: absolute; bottom: 90px; right: 20px; z-index: 1000; display: none;"></div>
        
        <form id="message-form">
            {% csrf_token %}
            <input type="hidden" id="room_id" value="{{ room.id }}">
            <div class="input-group">
                <button type="button" class="btn btn-dark border-secondary" id="emoji-btn">üòä</button>
                <input type="text" id="msg-content" class="form-control p-3" 
                       placeholder="√âcrivez votre message..." required autocomplete="off">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .message-bubble-other {
        background-color: #2b2f35 !important;
        color: #e9ecef !important;
        border: 1px solid #3e444c !important;
        border-radius: 15px 15px 15px 2px;
    }
    .message-bubble-me {
        background-color: #0d6efd !important;
        color: white !important;
        border: none !important;
        border-radius: 15px 15px 2px 15px;
    }
    .avatar { border: 2px solid #131517; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    #chat-box::-webkit-scrollbar { width: 5px; }
    #chat-box::-webkit-scrollbar-track { background: #0c0d0e; }
    #chat-box::-webkit-scrollbar-thumb { background: #2b2f35; border-radius: 10px; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
<script>
    let lastMessageId = 0;
    const currentUserName = "{{ user.username }}";
    // V√©rification si l'utilisateur est le cr√©ateur ou admin
    const isRoomCreator = ("{{ room.creator.username }}" === currentUserName || "{{ user.is_staff }}" === "True");

    const pickerOptions = { 
        onEmojiSelect: (emoji) => {
            const input = document.getElementById('msg-content');
            input.value += emoji.native;
            input.focus();
        },
        locale: 'fr',
        theme: 'dark'
    }
    const picker = new EmojiMart.Picker(pickerOptions);
    document.getElementById('emoji-picker-container').appendChild(picker);

    document.getElementById('emoji-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const container = document.getElementById('emoji-picker-container');
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', () => { document.getElementById('emoji-picker-container').style.display = 'none'; });

    function fetchMessages() {
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
        $.ajax({
            url: `/get_messages/{{ room.id }}/?last_id=${lastMessageId}`,
            method: 'GET',
            success: function(data) {
                data.messages.forEach(msg => {
                    let isMe = (msg.user === currentUserName);
                    let firstLetter = msg.user.charAt(0).toUpperCase();
                    let alignmentClass = isMe ? 'flex-row-reverse text-end' : 'flex-row';
                    let bubbleClass = isMe ? 'message-bubble-me' : 'message-bubble-other';
                    let marginClass = isMe ? 'me-3' : 'ms-3';

                    // Logique Signalement (Becker)
                    let flagHtml = "";
                    if (!isMe) {
                        if (msg.is_flagged) {
                            flagHtml = `<span class="badge bg-danger" style="font-size: 0.6rem;">Signal√©</span>`;
                        } else {
                            flagHtml = `
                                <form class="d-inline flag-form" data-msg-id="${msg.id}">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                    <button type="submit" class="btn btn-link btn-sm p-0 text-warning text-decoration-none" style="font-size: 0.7rem;">üö© Signaler</button>
                                    <span class="badge bg-danger d-none" style="font-size: 0.6rem;">Signal√©</span>
                                </form>`;
                        }
                    }

                    // Logique Suppression (Cr√©ateur/Admin)
                    let deleteBtnHtml = "";
                    if (isRoomCreator && msg.is_flagged) {
                        deleteBtnHtml = `
                            <form class="d-inline delete-msg-form" data-msg-id="${msg.id}">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <button type="submit" class="btn btn-link btn-sm p-0 text-danger text-decoration-none ms-2" 
                                        style="font-size: 0.7rem;" onclick="return confirm('Supprimer ce message d√©finitivement ?')">
                                    <i class="bi bi-trash"></i> Supprimer
                                </button>
                            </form>`;
                    }

                    let messageHtml = `
                        <div id="msg-${msg.id}" class="d-flex ${alignmentClass} mb-4 animate__animated animate__fadeInUp">
                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 35px; height: 35px; min-width: 35px; font-weight: bold; font-size: 0.9rem;">${firstLetter}</div>
                            <div class="${marginClass}" style="max-width: 75%;">
                                <div class="d-flex align-items-center mb-1 ${isMe ? 'flex-row-reverse' : ''}">
                                    <span class="fw-bold ${isMe ? 'ms-2' : 'me-2'}" style="font-size: 0.85rem;">${isMe ? 'Moi' : msg.user}</span>
                                    <span class="text-muted" style="font-size: 0.65rem;">${msg.timestamp}</span>
                                </div>
                                <div class="p-2 px-3 shadow-sm ${bubbleClass}" style="display: inline-block; text-align: left;">
                                    <p class="mb-0" style="font-size: 0.95rem; word-wrap: break-word;">${msg.content}</p>
                                </div>
                                <div class="mt-1">${flagHtml} ${deleteBtnHtml}</div>
                            </div>
                        </div>`;
                        
                    $('#chat-box').append(messageHtml);
                    lastMessageId = msg.id;
                });
                if (data.messages.length > 0) {
                    let chatBox = document.getElementById("chat-box");
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        });
    }

    function syncModeration() {
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
        $.ajax({
            url: `/get_flagged_ids/{{ room.id }}/`, // On utilise la nouvelle vue
            method: 'GET',
            success: function(data) {
                // --- 1. SUPPRESSION POUR TOUS ---
                $('#chat-box [id^="msg-"]').each(function() {
                    let numericId = parseInt($(this).attr('id').replace('msg-', ''));
                    if (!data.all_ids.includes(numericId)) {
                        $(this).addClass('animate__animated animate__fadeOut');
                        setTimeout(() => { $(this).remove(); }, 500);
                    }
                });

                // --- 2. APPARITION DU BOUTON ET DU BADGE ---
                data.flagged_ids.forEach(id => {
                    let msgDiv = $(`#msg-${id}`);
                    
                    // On v√©rifie si le message est affich√© ET s'il n'a pas encore le badge signal√©
                    if (msgDiv.length && msgDiv.find('.badge.bg-danger:not(.d-none)').length === 0) {
                        
                        // On cache le bouton "Signaler" et on affiche le badge "Signal√©"
                        msgDiv.find('.flag-form button').addClass('d-none');
                        msgDiv.find('.badge.bg-danger').removeClass('d-none');

                        // VERIFICATION : Si l'utilisateur est le cr√©ateur, on injecte le bouton de suppression
                        if (isRoomCreator) {
                            // On v√©rifie qu'on ne l'a pas d√©j√† ajout√© pour √©viter les doublons
                            if (msgDiv.find('.delete-msg-form').length === 0) {
                                let deleteBtnHtml = `
                                    <form class="d-inline delete-msg-form" data-msg-id="${id}">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                        <button type="submit" class="btn btn-link btn-sm p-0 text-danger text-decoration-none ms-2" 
                                                style="font-size: 0.7rem;" onclick="return confirm('Supprimer ce message ?')">
                                            <i class="bi bi-trash"></i> Supprimer
                                        </button>
                                    </form>`;
                                // On l'ajoute dans la zone de badges/boutons (mt-1)
                                msgDiv.find('.mt-1').append(deleteBtnHtml);
                            }
                        }
                    }
                });
            }
        });
    }
    setInterval(syncModeration, 3000); // V√©rifie toutes les 3 secondes

    $(document).ready(function() {
        fetchMessages();
        setInterval(fetchMessages, 3000);

        $('#message-form').on('submit', function(e) {
            e.preventDefault();
            let content = $('#msg-content').val();
            let roomId = $('#room_id').val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
            $.ajax({
                url: "{% url 'send_message' %}",
                type: "POST",
                data: { 'content': content, 'room_id': roomId, 'csrfmiddlewaretoken': csrfToken },
                success: function(res) { if (res.status === 'success') { $('#msg-content').val(''); fetchMessages(); } }
            });
        });

        // Action de signalement (Becker)
        $(document).on('submit', '.flag-form', function(e) {
            e.preventDefault();
            let form = $(this);
            $.ajax({
                url: `/flag/${form.data('msg-id')}/`,
                type: "POST",
                data: { 'csrfmiddlewaretoken': form.find('input[name=csrfmiddlewaretoken]').val() },
                success: function() { 
                    form.find('button').addClass('d-none'); 
                    form.find('.badge').removeClass('d-none'); 
                }
            });
        });

        // Action de suppression (Mod√©ration Cr√©ateur)
        $(document).on('submit', '.delete-msg-form', function(e) {
            e.preventDefault();
            let form = $(this);
            let msgId = form.data('msg-id');
            let messageDiv = $(`#msg-${msgId}`);

            $.ajax({
                url: `/message/${msgId}/delete/`,
                type: "POST",
                data: { 'csrfmiddlewaretoken': form.find('input[name=csrfmiddlewaretoken]').val() },
                success: function() {
                    messageDiv.addClass('animate__fadeOutRight');
                    setTimeout(() => { messageDiv.remove(); }, 500);
                }
            });
        });
    });
</script>
{% endblock %}