{% extends 'base.html' %}

{% block content %}
<h2>Salon : {{ room.name }}</h2>

<div id="chat-box" class="border p-3 mb-3" style="height: 300px; overflow-y: scroll; background: white;">
    {% for message in messages %}
        <div class="message mb-2">
            <strong>{{ message.user.username }}</strong>: {{ message.content }} 
            <small class="text-muted">({{ message.timestamp|date:"H:i" }})</small>

            {% if user.is_authenticated %}
                <form action="{% url 'flag_message' message.id %}" method="post" class="d-inline ms-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-warning py-0" style="font-size: 0.7rem;" title="Signaler ce message">
                        ðŸš© Signaler
                    </button>
                </form>
            {% endif %}

            {% if message.is_flagged %}
                <span class="badge bg-danger">SignalÃ©</span>
            {% endif %}
        </div>
    {% endfor %}
</div>

<form id="message-form">
    {% csrf_token %}
    <input type="hidden" id="room_id" value="{{ room.id }}">
    <div class="input-group">
        <input type="text" id="msg-content" class="form-control" placeholder="Ã‰crivez votre message..." required>
        <button type="submit" class="btn btn-primary">Envoyer</button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('#message-form').on('submit', function(e) {
            e.preventDefault();

            let content = $('#msg-content').val();
            let roomId = $('#room_id').val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val();

            $.ajax({
                url: "{% url 'send_message' %}",
                type: "POST",
                data: {
                    'content': content,
                    'room_id': roomId,
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function(response) {
                    if (response.status === 'success') {
                        $('#msg-content').val('');
                        fetchMessages(); // On appelle la fonction tout de suite au lieu d'attendre 3s
                    }
                },
                error: function() {
                    alert("Erreur lors de l'envoi du message.");
                }
            });
        });
    });
    let lastMessageId = 0; // Au dÃ©but, on n'a rien

    function fetchMessages() {
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val();

        $.ajax({
            url: `/get_messages/{{ room.id }}/?last_id=${lastMessageId}`,
            method: 'GET',
            success: function(data) {
                data.messages.forEach(msg => {
                    // 1. On prÃ©pare le bouton de signalement (le travail de Becker)
                    let flagForm = `
                        <form action="/flag/${msg.id}/" method="post" class="d-inline ms-2">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                            <button type="submit" class="btn btn-sm btn-outline-warning py-0" style="font-size: 0.7rem;" title="Signaler ce message">
                                ðŸš© Signaler
                            </button>
                        </form>`;

                    // 2. On construit le message avec EXACTEMENT le mÃªme HTML que le template Django
                    let messageHtml = `
                        <div class="message mb-2">
                            <strong>${msg.user}</strong>: ${msg.content} 
                            <small class="text-muted">(${msg.timestamp})</small>
                            ${flagForm}
                            ${msg.is_flagged ? '<span class="badge bg-danger">SignalÃ©</span>' : ''}
                        </div>`;

                    // 3. On injecte dans le chat-box
                    $('#chat-box').append(messageHtml);
                    
                    // On met Ã  jour l'ID pour ne pas rÃ©cupÃ©rer deux fois le mÃªme
                    lastMessageId = msg.id;
                });
                
                if (data.messages.length > 0) {
                    var chatBox = document.getElementById("chat-box");
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        });
    }

    // On appelle la fonction toutes les 3 secondes
    setInterval(fetchMessages, 3000);
</script>
{% endblock %}